// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      Role     @default(STAFF)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  staffProfile       StaffProfile?
  attendanceRecords  AttendanceRecord[]
  lunchBreaks        LunchBreak[]
  assignedTickets    Ticket[]        @relation("AssignedTickets")
  createdTickets     Ticket[]        @relation("CreatedTickets")
  ticketComments     TicketComment[]
  workspaces         Workspace[]
  cabinCallsAsStaff  CabinCall[]     @relation("StaffCalls")
  cabinCallsAsAdmin  CabinCall[]     @relation("AdminCalls")

  @@map("users")
}

model StaffProfile {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  fullName      String
  salary        Decimal  @db.Decimal(10, 2)
  workingDays   String   // Store as JSON string: ["Monday", "Tuesday", ...]
  officeTimeIn  String   // Format: "09:00"
  officeTimeOut String   // Format: "18:00"
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("staff_profiles")
}

model AttendanceRecord {
  id           Int       @id @default(autoincrement())
  userId       Int
  punchInTime  DateTime
  punchInLat   Decimal?  @db.Decimal(10, 8)
  punchInLng   Decimal?  @db.Decimal(11, 8)
  punchOutTime DateTime?
  punchOutLat  Decimal?  @db.Decimal(10, 8)
  punchOutLng  Decimal?  @db.Decimal(11, 8)
  workingHours Decimal?  @db.Decimal(5, 2) // Calculated working hours
  workDone     String?   @db.Text // Daily work summary
  date         DateTime  @db.Date // Date of attendance (for easy querying)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lunchBreaks LunchBreak[]

  @@index([userId, date])
  @@map("attendance_records")
}

model LunchBreak {
  id                 Int       @id @default(autoincrement())
  userId             Int
  attendanceRecordId Int
  lunchStartTime     DateTime
  lunchStartLat      Decimal?  @db.Decimal(10, 8)
  lunchStartLng      Decimal?  @db.Decimal(11, 8)
  lunchEndTime       DateTime?
  lunchEndLat        Decimal?  @db.Decimal(10, 8)
  lunchEndLng        Decimal?  @db.Decimal(11, 8)
  duration           Int?      // Duration in minutes
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendanceRecord AttendanceRecord @relation(fields: [attendanceRecordId], references: [id], onDelete: Cascade)

  @@index([userId, attendanceRecordId])
  @@map("lunch_breaks")
}

model Holiday {
  id          Int      @id @default(autoincrement())
  name        String
  date        DateTime @db.Date
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@map("holidays")
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  @db.Text
  color       String   @default("#3B82F6") // Default blue color
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tickets Ticket[]

  @@map("projects")
}

model Ticket {
  id            Int            @id @default(autoincrement())
  ticketNumber  String         @unique // e.g., "TKT-001"
  title         String
  description   String         @db.Text
  status        TicketStatus   @default(OPEN)
  priority      TicketPriority @default(MEDIUM)
  ticketType    TicketType     @default(STORY)
  storyPoints   Int?           // Story points for time estimation (1 point = 1 day)
  dueDate       DateTime       @db.Date
  assignedToId  Int?
  createdById   Int
  parentId      Int?           // Parent ticket for subtasks
  projectId     Int?           // Project this ticket belongs to (optional)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  assignedTo User?          @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: SetNull)
  createdBy  User           @relation("CreatedTickets", fields: [createdById], references: [id], onDelete: Cascade)
  project    Project?       @relation(fields: [projectId], references: [id], onDelete: SetNull)
  comments   TicketComment[]
  parent     Ticket?        @relation("TicketSubtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks   Ticket[]       @relation("TicketSubtasks")

  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([dueDate])
  @@index([parentId])
  @@index([ticketType])
  @@index([projectId])
  @@map("tickets")
}

model TicketComment {
  id        Int      @id @default(autoincrement())
  ticketId  Int
  userId    Int
  comment   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([userId])
  @@map("ticket_comments")
}

enum Role {
  ADMIN
  STAFF
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketType {
  EPIC
  STORY
  IMPROVEMENT
  BUG
}

model Workspace {
  id          Int      @id @default(autoincrement())
  userId      Int
  title       String
  link        String
  description String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("workspaces")
}

model CabinCall {
  id             Int       @id @default(autoincrement())
  staffId        Int
  adminId        Int
  message        String?   @db.Text
  status         CallStatus @default(PENDING)
  createdAt      DateTime  @default(now())
  acknowledgedAt DateTime?

  // Relations
  staff User @relation("StaffCalls", fields: [staffId], references: [id], onDelete: Cascade)
  admin User @relation("AdminCalls", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([staffId, status])
  @@map("cabin_calls")
}

enum CallStatus {
  PENDING
  ACKNOWLEDGED
  DISMISSED
}

